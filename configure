#!/bin/sh

try_cflag(){
	flag="$1"

	printf 'checking whether compiler accepts %s... ' "$flag"
	echo "typedef int abc;" >&$tmpfd

	if $CC "$flag" -c -o /dev/null "$ctmp" >/dev/null 2>&1
	then
		echo yes
		echo "CFLAGS_CONFIGURE += $flag" >> Makefile.cfg
	else
		echo no
	fi
}

if [ -z "$TMPDIR" ]
then
	TMPDIR=tmp/
	mkdir -p "$TMPDIR" || exit $?
	trap "rm -r '$TMPDIR'" EXIT
fi

if [ -z "$CC" ]
then
	CC=cc
fi

tmpfd=5
found=0

for i in $(seq 1 100)
do
	ctmp="$TMPDIR"/$i.c
	if 2>/dev/null $tmpfd>|$ctmp
	then
		found=1
		break
	fi
done

if [ $found -eq 0 ]
then
	echo "couldn't find unused temporary file in $TMPDIR" >&2
	exit 1
fi

trap "rm -f '$ctmp'" EXIT

echo > Makefile.cfg

echo "CC = $CC" >> Makefile.cfg

try_cflag -Wno-missing-field-initializers
try_cflag -Wno-missing-braces
try_cflag -Wmissing-prototypes
try_cflag -Wmissing-declarations
